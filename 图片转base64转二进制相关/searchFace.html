<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link rel="stylesheet" type="text/css" href="../../css/common.css"/>
		<link rel="stylesheet" type="text/css" href="../../iconFont/iconfont.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/faxiezuo.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/xiezuozonghetongji.css"/>
		<style type="text/css">
			/*input上传文件框   样式修改*/
			.a-upload{
				margin: 0.1rem 0.1rem;
				position: relative;
				/*height: 0.38rem;*/
				width: 100%;
				overflow: hidden;
				font-size: 0.14rem;
			}
			.a-upload #fileName{
				margin-left: 0.08rem;
			}
			.a-upload .fileContent{
				height: 0.35rem;
				line-height: 0.34rem;
				padding: 0px 0.05rem;
				display: inline-block;
				border: 1px solid #CCCCCC;
				-webkit-border-radius: 0.05rem;
				-moz-border-radius: 0.05rem;
				border-radius: 0.05rem;
			}
			.a-upload  input {
				width: 40%;
				height: 0.35rem;
			    position: absolute;
			    left: 0;
			    top: 0;
			    opacity: 0;
			    filter: alpha(opacity=0);
			    /*cursor: pointer;*/
			    display: inline-block;
			    outline: none;
			}
			/*input上传文件框   样式修改*/
			input[type='button']{
				    width: 85%;
				    height: 0.4rem;
				    background: #007AFF;
				    color: #FFFFFF;
				    text-align: center;
				    border: none;
				    outline: none;
				    -webkit-border-radius: 0.05rem;
				    -moz-border-radius: 0.05rem;
				    border-radius: 0.05rem;
				    font-size: 0.16rem;
			}
			form{
				width:100%;
			}
			.picSearch{
			}
			.picSearch label{
				font-size: 0.14rem;
				text-indent: 1em;
				background: #6786ED;
				width: 100%;
				padding: 10px 0px;
				color: #fff;
				display: block;
			}
			.picSearch .serh{
				padding:5px 0px 5px 10px;
				border-bottom:1px solid #CDCDCD;
			}
			.picSearch .serh input{
				text-align:left;
			}
			.picSearch .serh select{
				outline: none;
				width:30%;
				
			}.picSearch .serh option{
				outline: none;
			}
			/*查询结果展示*/
			.result{
				margin-top: 0.1rem;
			}
			.resultL{
				width: 1.2rem;
				height: 1.5rem;
				margin-right:0.05rem;
			}
			.resultL img{
				width: 100%;
				height: 100%;
			}
			.resultR{
				font-size: 0.12rem;
				padding-top:0.2rem;
			}
			.resultR p{
				padding: 0.05rem 0;
			}
			.content{
				margin-top:0.1rem;
			}
			/*查询结果展示结束*/
			
			/*tab切换*/
			.tabHead ul li{
				width: 33.3%;
				text-align: center;
				padding: 0.1rem 0;
			}
			.tab{
				display: none;
			}
		</style>
		<script src="../../js/Rem.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<body>
		<div class="box">
			<div class="head"><a id="head" href="javascript:history.back(-1);" class="back pull-left iconfont icon-zuojiantou"></a><span class="pull-left">公情搜脸</span></div>
			
			<ul class="tabChange clearfix" id="tabChange">
		   		<li class="active">照片搜索</li>
		   		<li>信息搜索</li>
		   		<li>信息添加</li>
		   	</ul>
			<!--图片搜索开始-->
			<div class="tab" style="display: block;">
			<form id="form1" method="post">
				<div class="picSearch" style="text-align: center;">
					<label>照片搜索</label>
					<div align="left" class="a-upload uploadphoto"><span class="fileContent" >点击上传图片</span><span id="fileName"></span></div>
					<!--<input type="file" id="uploadphoto" name="photoupload" value="请点击上传图片"   />--> 
					<img id="img1" src=""/>
				</div>
			</form>
			<div style="text-align:center;margin-bottom: 0.1rem;">
				<input type="button" id="btn1" value="点击查询"   />
			</div>
			<!--图片搜索结束-->
			</div>
			<!--信息搜索开始-->
			<div class="tab">
			<form id="form2" method="post">
				<div class="picSearch">
					<label>信息搜索</label>
					<div style="margin:0.2rem 0">
						<div class="serh">
							<span>姓 &nbsp; &nbsp;名 : </span><input type="text" name="imgname" id="imgname" placeholder="请输入姓名" />
						</div>
						<div class="serh">
							<span>证件号 : </span><input type="text" name="imgcard" id="imgcard" placeholder="证件号" />
						</div>
					</div>
				</div>
			</form>
			<div style="text-align:center;margin-bottom: 0.1rem;">
				<input type="button" id="btn2" value="点击查询"   />
			</div>
			</div>
			<!--添加信息-->
			<div class="tab">
			<form id="form3" method="post">
				<div class="picSearch">
					<label>信息添加</label>
					<div style="margin:0.2rem 0">
						<div class="serh">
							<span>姓 &nbsp; &nbsp;&nbsp;&nbsp;名 : </span><input type="text" name="imgname" id="imgname" placeholder="请输入姓名" />
						</div>
						<div class="serh">
							<span>证件号码 : </span><input type="text" name="imgcard" id="imgcard" placeholder="证件号" />
						</div>
						<div class="serh">
							<span>证件类型 : </span>
							<select>
								<option value="1">身份证</option>
								<option value="2">护照</option>
								<option value="3">其他</option>
							</select>
						</div>
						<div align="left" class="a-upload uploadphoto"><span class="fileContent">点击上传图片</span><span id="fileName"></span></div>
						<div style="text-align: center;">
							<img id="img2" src=""/>
						</div>
					</div>
				</div>
			</form>
			<div style="text-align:center;margin-bottom: 0.1rem;">
				<input type="button" id="btn3" value="点击查询"   />
			</div>
			</div>
			<div class="result" id="result">
				
			</div>
		</div>
	</body>
</html>
<script src="../../js/jquery-1.7.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/LocalResizeIMG.js"  type="text/javascript" charset="utf-8"></script>
<script src="../../js/mobileBUGFix.mini.js"  type="text/javascript" charset="utf-8"></script>
<script src="../../js/layer2.1/layer.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/jquery.form.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/base.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	  /**
 * 获取blob对象的兼容性写法
 * @param buffer
 * @param format
 * @returns {*}
 */
function getBlob(buffer, format) {
  try {
    return new Blob(buffer, {type: format});
  } catch (e) {
    var bb = new (window.BlobBuilder || window.WebKitBlobBuilder || window.MSBlobBuilder);
    buffer.forEach(function(buf) {
      bb.append(buf);
    });
    return bb.getBlob(format);
  }
}
		var fd=null;
		mui.plusReady(function(){
		//图片显示  
       function showPics(url,name){          
         //根据路径读取到文件   
           plus.io.resolveLocalFileSystemURL(url,function(entry){  
               entry.file( function(file){  
                   var fileReader = new plus.io.FileReader();  
                   fileReader.readAsDataURL(file);  
                   fileReader.onloadend = function(e) {
                           var picUrl = e.target.result.toString(); 
                           console.log(picUrl)
                           console.log(index)
                           if(index==0){
                           		$("#img1").attr("src",picUrl);
                           }else if(index==2){
                           	$("#img2").attr("src",picUrl);
                           }
                          	
                          		var arr = picUrl.split(',');
					    	   var type = arr[0].match(/:(.*?);/)[1];//获得图片的类型
					////////////////---把base64转化为二进制----//////////////////
					    		var text = window.atob(picUrl.split(",")[1]);
							    var buffer = new Uint8Array(text.length);
							   
							    var pecent = 0, loop = null;
							    for (var i = 0; i < text.length; i++) {
							      buffer[i] = text.charCodeAt(i);
							    }
							    var blob = getBlob([buffer], type);
							    console.log(blob.size/1024+"kb");
							    fd = new FormData();//上边是FormData的介绍
		   						fd.append('photoupload',blob);
		   						console.log(fd)
                        }  
               });  
          });   
       }  
        //压缩图片    
       function compressImage(url,filename){    
           var name="_doc/upload/"+filename;  
           plus.zip.compressImage({    
                   src:url,//src: (String 类型 )压缩转换原始图片的路径    
                   dst:name,//压缩转换目标图片的路径    
                   quality:100,//quality: (Number 类型 )压缩图片的质量.取值范围为1-100    
                   overwrite:true,//overwrite: (Boolean 类型 )覆盖生成新文件    
                   width:"200px",
                   height:"250px"
               },    
               function(zip) {  
                   //页面显示图片  
                   showPics(zip.target,name);  
               },function(error) {    
                   plus.nativeUI.toast("压缩图片失败，请稍候再试");    
           });    
       }   
        
        //调用手机摄像头并拍照  
       function getImage() {    
           var cmr = plus.camera.getCamera();    
           cmr.captureImage(function(p) {    
               plus.io.resolveLocalFileSystemURL(p, function(entry) {    
                   compressImage(entry.toLocalURL(),entry.name);    
               }, function(e) {    
                   plus.nativeUI.toast("读取拍照文件错误：" + e.message);    
               });    
           }, function(e) {    
           }, {    
               filter: 'image'   
           });    
       }  
       //从相册选择照片  
       function galleryImgs() {    
            plus.gallery.pick(function(e) {    
                var name = e.substr(e.lastIndexOf('/') + 1);  
               compressImage(e,name);  
            }, function(e) {    
            }, {    
                filter: "image"    
            });    
        }  
         
       //点击事件，弹出选择摄像头和相册的选项  
//      function showActionSheet() {   
	$(".uploadphoto").click(function(){
		console.log()
		 var bts = [{    
                title: "拍照"    
            }, {    
                title: "从相册选择"    
            }];    
            plus.nativeUI.actionSheet({    
                    cancel: "取消",    
                    buttons: bts    
                },    
                function(e) {    
                    if (e.index == 1) {    
                        getImage();    
                    } else if (e.index == 2) {    
                        galleryImgs();    
                    }    
                }    
            ); 
	})
              
})
		
//图片搜索     http://10.24.102.36/api/search_img/format/json
$("#btn1").click(function(){
	if($("#img1").attr("src")==""){
		diaLog("请上传图片");
		return false;
	}
	$("#btn1").attr("disabled",true);
	$.ajax({
		   type: "POST",
		   url:"http://10.24.102.36/api/search_img/format/json",
		   data: fd,
           contentType: false,//这个一定要写
           processData: false,//这个也一定要写，不然会报错
		   dataType:"json",//返回类型，有json，text，HTML。这里并没有jsonp格式，如果返回的是jsonp格式,就无法用jsonp实现跨域
		   jsonp:"callback",
		   success:function(data){
		   	console.log(data)
			  if(data.success){
			  	var list=data.list;
			  	var tabHtml="";
			  	for(var i=0;i<list.length;i++){
			  		var item=list[i];
			  		tabHtml+='<div class="clearfix content"><div class="resultL pull-left">'+
								'<img src="http://119.90.53.231/'+item.imgurl+'"/>'+
							'</div>'+
							'<div class="resultR pull-left">'+
								'<p><span>身份证号:</span><span>'+item.imgcard+'</span></p>'+
								'<p><span>姓名:</span><span>'+item.imgname+'</span></p>'+
								'<p><span>相似度:</span><span>'+item.score+'</span></p>'+
							'</div></div>';
			  	}
			  }
			  $("#result").html(tabHtml);
		   }, 
			error:function(){ //上传失败 
			  	alert("error")
			}
	}); 
})
//信息搜索      http://10.24.102.36/api/search_info/format/json
$("#btn2").click(function(){
	var form2=$("#form2");
	var imgname=$.trim($("#imgname").val());
	var imgcard=$.trim($("#imgcard").val());
	var idCardReg=/^[1-9]{1}[0-9]{14}$|^[1-9]{1}[0-9]{16}([0-9]|[xX])$/;//身份证验证
	if(imgname==""&&imgcard==""){
		diaLog("请填写任意一项")
	}
	   if(imgcard!=""){
		   if(!idCardReg.test(idCard)){
		   	 	alert('请填写正确的身份证');
			   	return false;
		   	 }
	   } 
	var options = {    
			url:'http://10.24.102.36/api/search_info/format/json',   
			type:'post', 
			dataType:'json',
			jsonp:'callback',
			success:function(data) {
				console.log(data)
			  if(data.success){
			  	var list=data.list;
			  	var tabHtml="";
			  	console.log(data)
			  	for(var i=0;i<list.length;i++){
			  		var item=list[i];
			  		tabHtml+='<div class="clearfix content"><div class="resultL pull-left">'+
								'<img src="http://119.90.53.231/'+item.imgurl+'"/>'+
							'</div>'+
							'<div class="resultR pull-left">'+
								'<p><span>身份证号:</span><span>'+item.imgcard+'</span></p>'+
								'<p><span>姓名:</span><span>'+item.imgname+'</span></p>'+
								'<p><span>相似度:</span><span>'+item.score+'</span></p>'+
							'</div></div>';
			  	}
			  }
			  $("#result").html(tabHtml);
			},
			error:function(){
				diaLog('发送失败');
			}
		};  
		
		form2.ajaxSubmit(options);
})
//添加信息   http://10.24.102.36/api/add/format/json
$("#btn3").click(function(){
	console.log(fd)
	var form3=$("#form3");
	var options = {    
		   type: "POST",
		   url:"http://10.24.102.36/api/add/format/json",
		   data: fd,
           contentType: false,//这个一定要写
           processData: false,//这个也一定要写，不然会报错
		   dataType:"json",//返回类型，有json，text，HTML。这里并没有jsonp格式，如果返回的是jsonp格式,就无法用jsonp实现跨域
		   jsonp:"callback",
			success:function(data) {
				diaLog("添加成功")				
			},
			error:function(){
				diaLog('添加失败');
			}
		};  
		form3.ajaxSubmit(options);
})

//tab切换
var index=0;
$("#tabChange li").click(function(){
	index=$(this).index();
	$(this).addClass("active").siblings().removeClass("active");
	$(".tab").eq(index).show().siblings(".tab").hide();
	console.log(index)
})
</script>